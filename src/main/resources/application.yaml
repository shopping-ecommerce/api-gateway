server:
  port: 8888

app:
  api-prefix: /shopping/api

spring:
  application:
    name: shopping
  cloud:
    gateway:
      routes:
        - id: auth-service
          uri: ${AUTH_URL:http://auth-service:8080}
          predicates:
            - Path=${app.api-prefix}/authentication/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
#            - name: CircuitBreaker
#              args:
#                name: authenticationFallback
#                fallbackUri: forward:/fallback/auth
        - id: notify-service
          uri: ${NOTIFY_URL:http://notify-service:8081}
          predicates:
            - Path=${app.api-prefix}/notifications/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
#            - name: CircuitBreaker
#              args:
#                name: notificationFallback
#                fallbackUri: forward:/fallback/notification
        - id: user-service
          uri: ${USER_URL:http://user-service:8082}
          predicates:
            - Path=${app.api-prefix}/info/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
#            - name: CircuitBreaker
#              args:
#                name: userFallback
#                fallbackUri: forward:/fallback/profiles
        - id: product-service
          uri: ${PRODUCT_URL:http://product-service:8083}
          predicates:
                - Path=${app.api-prefix}/products/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
        - id: file-service
          uri: ${FILE_URL:http://file-service:8084}
          predicates:
            - Path=${app.api-prefix}/file/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
        - id: chat-ai-service
          uri: ${CHAT_AI_URL:http://chat-ai-service:8085}
          predicates:
            - Path=${app.api-prefix}/chat/**
          filters:
              - StripPrefix=2
              - name: RequestRateLimiter
                args:
                  key-resolver: "#{@ipKeyResolver}"
                  redis-rate-limiter.replenishRate: 10
                  redis-rate-limiter.burstCapacity: 20
        - id: order-service
          uri: ${ORDER_URL:http://order-service:8086}
          predicates:
            - Path=${app.api-prefix}/order/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
        - id: cart-service
          uri: ${CART_URL:http://cart-service:8087}
          predicates:
            - Path=${app.api-prefix}/cart/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@ipKeyResolver}"
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
      default-filters:
        - name: Retry
          args:
            retries: 3
            methods: GET,POST
            backoff:
              firstBackoff: 50ms
              maxBackoff: 500ms
              factor: 2
              basedOnPreviousValue: false
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 100
        failureRateThreshold: 50
        waitDurationInOpenState: 20s
        permittedNumberOfCallsInHalfOpenState: 10
        minimumNumberOfCalls: 10
        automaticTransitionFromOpenToHalfOpenEnabled: true
    instances:
      authenticationFallback:
        baseConfig: default
      userFallback:
        baseConfig: default
      notificationFallback:
        baseConfig: default
      fileFallback:
        baseConfig: default
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
  endpoint:
    health:
      show-details: always

services:
  url:
    auth-service: ${AUTH_URL:http://auth-service:8080}
#logging:
#  level:
#    org.springframework.cloud.gateway: TRACE
#    reactor.netty: DEBUG
#    org.springframework.web: DEBUG